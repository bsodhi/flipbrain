var sharedMod=angular.module("srs.SharedServices",[]);
sharedMod.config(["$httpProvider",function(a){a.interceptors.push(["$q","$rootScope",function(a,e){return{request:function(a){$("#ajax-waiting").addClass("animate-text");$("#ajax-loader").show();return a},requestError:function(g){$("#ajax-waiting").removeClass("animate-text");$("#ajax-loader").hide();return a.reject(g)},response:function(a){$("#ajax-waiting").removeClass("animate-text");$("#ajax-loader").hide();e.$broadcast("ClearMessages",[]);return a},responseError:function(e){$("#ajax-waiting").removeClass("animate-text");
$("#ajax-loader").hide();C.log("Error occurred: >>>>>> "+JSON.stringify(e));return a.reject(e)}}}])}]);
sharedMod.factory("Shared",["$http","$route",function(a,c){var e={User:{loggedIn:!1},loginTooltip:function(a){return e.User.loggedIn?void 0:a},requireLogin:function(){C.log("Skipping requireLogin()")},init:function(){C.log("Shared.init().");a.get("/user/getSessionDetails.a").success(function(a,b,f,h){"OK"===a.Status?(m=a.Message,void 0!==m.User&&(e.User=m.User,e.User.loggedIn=!0),e.Subscriptions=void 0!==m.Subscriptions?m.Subscriptions:[]):C.log("Shared.init(): Failed to load session data: "+JSON.stringify(a.Message));
c.reload();C.log("Shared.init(): Loaded User: "+JSON.stringify(e.User))}).error(function(a,b,f,h){a="Shared.init(): Error occurred: "+JSON.stringify(a);C.log(a)})},dateDiffFromNow:function(a){a=new Date(a);a=Math.ceil(new Date/864E5)-Math.ceil(a/864E5);var b=Math.abs(a);return 0<a?b+" days ago.":"After "+b+" days."}};try{void 0!==gapi?gapi.load("auth2",function(){e.auth=gapi.auth2.init({client_id:"419854404423-9f472gsk77jc1p9jnp7umbnj17b2u3tq.apps.googleusercontent.com",scope:"email"});C.log("Initialized auth.")}):
C.log("Could not initialize auth: gapi="+gapi)}catch(g){console.error(g)}e.QTypes={MCMA:"Multiple choice multiple answer",MCSA:"Multiple choice single answer",FTXT:"Free form text"};return e}]);sharedMod.directive("uppercase",function(){return{require:"ngModel",link:function(a,c,e,g){c=function(a){if(void 0!==a){var b=a.toUpperCase();a!==b&&(g.$setViewValue(b),g.$render());return b}};g.$parsers.push(c);c(a[e.ngModel])}}});
sharedMod.directive("dateinput",["$filter",function(a){return{require:"^ngModel",restrict:"A",link:function(c,e,g,d){d.$formatters.push(function(b){return b?a("date")(b,"dd/MM/yyyy"):""});d.$parsers.push(function(b){return a("date")(b,"dd/MM/yyyy")})}}}]);sharedMod.directive("currencyInput",["$filter",function(a){return{require:"^ngModel",restrict:"A",link:function(c,e,g,d){d.$formatters.unshift(function(b){return b?a("currency")(b):""})}}}]);
sharedMod.directive("compareTo",function(){return{require:"ngModel",scope:{otherModelValue:"=compareTo"},link:function(a,c,e,g){g.$validators.compareTo=function(d){return d===a.otherModelValue};a.$watch("otherModelValue",function(){g.$validate()})}}});var srsApp=angular.module("srsApp","ngRoute ngAnimate srs.SharedServices ui.bootstrap htmlSortable textAngular".split(" ")).config(["$routeProvider","$locationProvider",function(a,c){a.when("/Index",{templateUrl:"/web/partials/home.html"});a.when("/Why",{templateUrl:"/web/partials/why.html"});a.when("/Register",{templateUrl:"/web/partials/register.html"});a.when("/Search/:q",{templateUrl:"/web/partials/search.html"});a.when("/MyTrails",{templateUrl:"/web/partials/trails.html"});a.when("/MyAssessments",
{templateUrl:"/web/partials/myAssessments.html"});a.when("/Subs",{templateUrl:"/web/partials/subscriptions.html"});a.when("/Trail/:tid",{templateUrl:"/web/partials/trailDetails.html"});a.when("/Trail",{templateUrl:"/web/partials/trailDetails.html"});a.when("/ViewTrail/:tid",{templateUrl:"/web/partials/viewTrail.html"});a.when("/MyContent",{templateUrl:"/web/partials/portfolio.html"});a.when("/Question",{templateUrl:"/web/partials/question.html"});a.when("/Question/:qid",{templateUrl:"/web/partials/question.html"});
a.when("/Assessment",{templateUrl:"/web/partials/assessment.html"});a.when("/Assessment/:aid",{templateUrl:"/web/partials/assessment.html"});a.when("/TakeAssessment/:aid",{templateUrl:"/web/partials/takeAssessment.html"});a.when("/EditSubmission/:aid",{templateUrl:"/web/partials/takeAssessment.html"});a.when("/AssessmentResult/:sid",{templateUrl:"/web/partials/assessmentResult.html"});a.when("/Profile/:pid",{templateUrl:"/web/partials/register.html"});a.when("/Register",{templateUrl:"/web/partials/register.html"});
a.when("/Login",{templateUrl:"/web/partials/login.html"});a.when("/Logout",{templateUrl:"/web/partials/logout.html",controller:"DummyCtrl"});a.otherwise({redirectTo:"/Index"});c.html5Mode(!1)}]);srsApp.controller("DummyCtrl",["$scope",function(a){}]);
srsApp.config(["$provide",function(a){a.decorator("taOptions",["$delegate",function(a){a.toolbar=[["p","pre","quote"],"bold italics underline strikeThrough ul ol clear".split(" "),["justifyLeft","justifyCenter","justifyRight","indent","outdent"],["html","insertImage","insertLink"]];return a}])}]);
var C={YT_URL_MAIN:"www.youtube.com",YT_URL_SHORT:"youtu.be",YT_URL_EMBED:"http://www.youtube-nocookie.com/embed/",YT_URL_THUMBNAIL:"http://img.youtube.com/vi/",parseUrl:function(a){var c=document.createElement("a");c.href=a;return c},getVideoID:function(a){a=C.parseUrl(a);var c;a.hostname===C.YT_URL_MAIN&&"/watch"===a.pathname?c=a.search.split("=")[1]:a.hostname===C.YT_URL_SHORT&&(c=a.pathname);return c.slice(c.indexOf("/")+1)},thumbnailUrl:function(a){return C.YT_URL_THUMBNAIL+C.getVideoID(a)+"/mqdefault.jpg"},
videoEmbedUrl:function(a){return C.YT_URL_EMBED+C.getVideoID(a)},log:function(a){console.log(a)}};srsApp.controller("AppCtrl",["$scope","$http","$location","$routeParams","Shared",function(a,c,e,g,d){C.log("Init AppCtrl: $location=("+JSON.stringify(e)+". $routeParams=("+JSON.stringify(g)+")");a.Model={Trails:[],Trail:{items:[]},temp:{showComment:[],editComment:[],Content:{}},TrailItem:{comments:[]},Contents:[]};a.Model.getSubsForUser=function(){c.get("/user/getSubsForUser.a?userId="+d.User.userId).success(function(b){"OK"===b.Status?d.Subscriptions=b.Message:a.setStatus("Failed to load subscriptions.")})};
a.Model.init=function(){C.log("Model.init().");var b=e.path();C.log("path="+b+". $routeParams="+JSON.stringify(g));a.RootModel.modalStatus=void 0;0===b.indexOf("/Subs")&&a.Model.getSubsForUser()};a.Model.init();C.log("AppCtrl: Loaded.")}]);srsApp.controller("ProfileCtrl",["$scope","$http","$location","$routeParams","Shared",function(a,c,e,g,d){C.log("ProfileCtrl ...");a.Shared=d;a.Reg=d.User;void 0!==g.pid&&c.get("/user/getCurrentUser.a").success(function(b){"OK"===b.Status?(C.log("Loaded user profile: "+JSON.stringify(b.Message)),a.Reg=b.Message):(C.log("Failed to load profile: "+JSON.stringify(b.Message)),a.setStatus("Could not load profile!"))});a.saveProfile=function(){a.formErrors=[];var b=[],f=a.Reg,h=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
void 0!==f.email&&h.test(f.email)||b.push("Please provide a valid email as login.");(void 0===f.firstName||2>f.firstName.length)&&b.push("Please provide your first/given name.");(void 0===f.lastName||2>f.lastName.length)&&b.push("Please provide your last/family name.");0<b.length?a.formErrors=b:c.post(d.User.loggedIn?"/user/saveUser.a":"/user/register.a",a.Reg).success(function(b){C.log("Registeration result: "+JSON.stringify(b));"OK"!==b.Status?a.setStatus(b.Message):d.User.loggedIn?(d.User=b.Message,
d.init(),a.Reg=b.Message,e.path("/Profile/"+b.Message.userId).replace(),a.setStatus("Saved profile!")):e.path("/Login").replace()})}}]);
srsApp.controller("LoginCtrl",["$scope","$http","$location","$q","Shared",function(a,c,e,g,d){a.LF={};a.PR={};a.Shared=d;C.log("LoginCtrl ...");a.requestPassword=function(){C.log("resetPassword called.");c.get("/user/requestPassword.a?email="+a.PR.email).success(function(b){"OK"===b.Status?(C.log("resetPassword result: "+JSON.stringify(b.Message)),e.path("/No-exitent").replace()):a.setStatus("Could not reset the password.")})};a.login=function(){c.post("/user/login.a",a.LF).success(function(b,f,h,
c){C.log("Login result: "+JSON.stringify(b));"OK"===b.Status?(d.init(),a.LF={},e.path("/No-exitent").replace(),d.auth.currentUser.get().disconnect()):a.setStatus(b.Message)}).error(function(b,f,d,c){a.setStatus(b.Message)})};a.requestPassword=function(){C.log("resetPassword called.");c.get("/user/requestPassword.a?email="+a.PR.email).success(function(b){a.setStatus(b.Message)})};a.gapiAuth2SignIn=function(){d.auth.signIn({scope:"profile email"}).then(function(b){if(b.isSignedIn()){C.log("successful login");
var f=b.getBasicProfile();C.log("Profile: "+JSON.stringify(f));a.LF.auth2Code=b.getAuthResponse().id_token;a.LF.email=f.getEmail();b=f.getName().split(" ");a.LF.firstName=b[0];a.LF.lastName=b[b.length-1];a.login()}else C.log("login failed")});C.log("gapiAuth2SignIn")}}]);
srsApp.controller("IndexCtrl",["$scope","$http","$location","$q","Shared",function(a,c,e,g,d){C.log("Init IndexCtrl...");a.RootModel={Data:{}};a.Reg={};a.Shared=d;a.setStatus=function(b){a.StatusMessage=b;$("#statusmsg").fadeIn(400)};a.hideStatus=function(){a.StatusMessage=void 0;$("#statusmsg").fadeOut(400)};a.RootModel.getThumbnailUrl=function(a){return C.thumbnailUrl(a)};a.RootModel.getVideoUrl=function(a){return C.videoEmbedUrl(a)};a.RootModel.search=function(){var b=a.RootModel.q;void 0===b||
1>b.length?a.setStatus("Please supply some meaningful query."):e.path("/Search/"+b)};a.logout=function(){c.get("/user/logout.a").success(function(a){C.log("Logged out: "+JSON.stringify(a));d.User={};e.path("/No-exitent").replace()})};a.signOut=function(){d.auth.currentUser.get().disconnect();C.log("Disconnected");a.logout()};a.$on("Errors",function(b,f){a.Errors=f;a.Invalid=0<f.length;C.log("Got errors: "+JSON.stringify(f)+". Invalid="+a.Invalid);a.setStatus("Your request could not be processed. Error occurred.")});
a.$on("ClearMessages",function(b,f){a.Errors=[];a.Invalid=!1;a.hideStatus()});d.init();C.log("IndexCtrl: Loaded.")}]);srsApp.controller("SearchCtrl",["$scope","$http","$routeParams",function(a,c,e){C.log("SearchCtrl: "+JSON.stringify(e));c.get("/user/search.a?q="+e.q).success(function(c){"OK"===c.Status?(C.log("Search results: "+JSON.stringify(c.Message)),a.RootModel.Data.Trails=c.Message):a.setStatus("Search failed. Please try again later!")})}]);
srsApp.controller("HomeCtrl",["$scope","$http","$routeParams","Shared",function(a,c,e,g){C.log("HomeCtrl: "+JSON.stringify(e));a.pageNo=1;a.loadData=function(){c.get("/user/getDataForHomePage.a?pageNo="+a.pageNo).success(function(d){if("OK"===d.Status)for(m=d.Message,1===a.pageNo&&(a.RootModel.Data.Trails=[]),a.hasNext=0<m.Trails.length;0<m.Trails.length;)a.RootModel.Data.Trails.push(m.Trails.splice(0,4));else a.setStatus("Failed to get data.")}).error(function(a){a="Error occurred: "+JSON.stringify(a);
C.log(a)})};a.loadData();a.nextPage=function(){a.pageNo+=1;a.loadData()};a.prevPage=function(){--a.pageNo;a.loadData()}}]);srsApp.controller("UserAssessCtrl",["$scope","$http","Shared",function(a,c,e){e.requireLogin();a.Model={loaded:!1,A:[],temp:{}};a.Sort={pred1:"submittedOn",rev1:!0};c.get("/assess/getAssessmentsTakenByUser.a").success(function(c){"OK"===c.Status?(a.Model.A=c.Message,a.Model.loaded=!0):a.setStatus("Failed to load assessments.")}).error(function(c,d,b,f){a.setStatus(c.Message);a.Model.loaded=!0});C.log("Loaded UserAssessCtrl...")}]);
srsApp.controller("PortfolioCtrl",["$scope","$http","$location","Shared",function(a,c,e,g){g.requireLogin();a.Model={loaded:!1,PF:{},temp:{YT:{}},Trail:{videos:[],resources:[]}};a.Sort={pred1:"submittedOn",rev1:!0,pred2:"type",rev2:!1,pred3:"openTime",rev3:!1,pred4:"updTs",rev4:!0,pred5:"updTs",rev5:!0};C.log("Loaded PortfolioCtrl...");c.get("/assess/getPortfolio.a").success(function(d){"OK"===d.Status?(a.Model.PF=d.Message,a.Model.loaded=!0):a.setStatus("Failed to load portfolio.")}).error(function(d,
b,f,c){a.setStatus(d.Message);a.Model.loaded=!0});a.addContent=function(){a.Model.PF.content.push(a.Model.temp.Content);a.saveContent(a.Model.temp.Content,!0);a.RootModel.modalStatus="Saved the content!";a.Model.temp={}};a.addYTContent=function(){var d=a.Model.temp.YT;void 0===d.url||10>d.url.length?a.RootModel.modalStatus="Please provide valid URL(s)!":c.post("/trail/addYTContent.a",d).success(function(b){"OK"===b.Status?(a.Model.PF.content.push(b.Message),a.RootModel.modalStatus="Saved the content!",
a.Model.temp={}):a.setStatus("Failed to add content.")})};a.addYTrail=function(){var d=a.Model.temp.YT;void 0===d.resource||10>d.resource.length?a.RootModel.modalStatus="Please provide valid playlist/videos!":c.get("/trail/addYTrail.a",{params:d}).success(function(b){"OK"===b.Status?($("#ytrailModal").modal("hide"),void 0===a.Model.PF.trails&&(a.Model.PF.trails=[]),a.Model.PF.trails.push(b.Message)):a.setStatus("Failed to add trail.")})};a.saveContent=function(d,b){c.post("/trail/saveContent.a",d).success(function(f){"OK"===
f.Status?b||a.setStatus("Saved content!"):b||a.setStatus("Failed to saved content.")})};a.removeContent=function(d){c.get("/trail/deleteContent.a?cid="+d.contentId).success(function(b){"OK"===b.Status?(b=a.Model.PF.content.indexOf(d),a.Model.PF.content.splice(b,1),a.setStatus("Content deleted!")):a.setStatus("Failed to delete content.")})};a.addToTrail=function(){C.log("Adding to trail...");a.RootModel.modalStatus=void 0;var d=!1;angular.forEach(a.Model.PF.content,function(b,f){if(b.isSelected){d=
!0;var c={content:{contentId:b.contentId}};"V"===b.contentType?a.Model.Trail.videos.push(c):a.Model.Trail.resources.push(c)}});d||(a.RootModel.modalStatus="Please first select some items to add!")};a.saveTrail=function(d){c.post("/trail/saveTrail.a",a.Model.Trail).success(function(b){var f="Saved the trail!";"OK"===b.Status?a.Model.Trail=b.Message:f="Failed to save the trail!";d?a.RootModel.modalStatus=f:a.setStatus(f)})};a.createAssessFromQ=function(){var d=[];angular.forEach(a.Model.PF.questionBank,
function(a){qq={questionId:a.questionId,title:a.title,description:a.description};a.selected&&d.push(qq)});g.aqList=d;e.path("/Assessment")}}]);
srsApp.controller("QuestionCtrl",["$scope","$http","$routeParams","Shared","$location",function(a,c,e,g,d){g.requireLogin();a.Q={answerOptions:[]};C.log("Loaded QuestionCtrl...");e=e.qid;void 0!==e&&c.get("/assess/getQuestion.a?qid="+e).success(function(b){"OK"===b.Status?a.Q=b.Message:a.setStatus("Failed to load question.")}).error(function(b,f,d,c){a.setStatus(b.Message)});a.addOpt=function(){a.Q.answerOptions.push({})};a.save=function(){c.post("/assess/saveQuestion.a",a.Q).success(function(b){"OK"===
b.Status?(a.Q=b.Message,a.setStatus("Saved question!"),d.path("/Question/"+b.Message.questionId)):a.setStatus("Failed to save question!")}).error(function(b,f,d,c){a.setStatus(b.Message)})}}]);
srsApp.controller("AssessmentViewCtrl",["$scope","$http","$routeParams","Shared","$location",function(a,c,e,g,d){g.requireLogin();a.A={questions:[],responses:[]};g=0===d.path().indexOf("/EditSubmission")?"getAssessmentSubmission.a":"getAssessmentForTaking.a";c.get("/assess/"+g+"?id="+e.aid).success(function(b){"OK"===b.Status?a.A=b.Message:a.setStatus("Failed to process request.")}).error(function(b,f,d,c){a.setStatus(b.Message)});a.isSubmitted=function(){return void 0!==a.A.draft&&!a.A.draft};a.getMarkedAns=
function(){var b=[];a.A.questions.forEach(function(a,d,c){d=a.answerOptions.filter(function(b,d,c){return b.marked||"FTXT"===a.type&&void 0!==b.response});C.log("Marked: "+JSON.stringify(d));d.forEach(function(d){var c={};c.answer=d.answer;c.questionId=a.questionId;"FTXT"===a.type&&(c.answer=d.response);b.push(c)})});return{assessId:a.A.assessId,responses:b,submissionId:a.A.submissionId}};a.save=function(b){if(confirm("Sure you want to "+(b?"submit":"save")+"?")){var f=a.getMarkedAns();f.draft=!b;
C.log("Sending for save: "+JSON.stringify(f));c.post("/assess/saveAssessmentResponse.a",f).success(function(f){"OK"===f.Status?(a.A.submissionId=f.Message.submissionId,b?(a.setStatus("Submitted responses!"),d.path("/AssessmentResult/"+f.Message.submissionId)):(a.setStatus("Saved responses as a draft!"),d.path("/EditSubmission/"+f.Message.submissionId))):a.setStatus("Could not save data.")}).error(function(b,f,d,c){a.setStatus(b.Message)})}}}]);
srsApp.controller("AssessmentResultCtrl",["$scope","$http","$routeParams","Shared",function(a,c,e,g){g.requireLogin();a.A={questions:[],responses:[]};C.log("Getting assessment result...");c.get("/assess/getAssessmentResult.a?id="+e.sid).success(function(d){"OK"===d.Status?a.A=d.Message:a.setStatus(d.Message)}).error(function(d,b,f,c){a.setStatus(d.Message)});a.showAns=function(a,b){C.log("q="+JSON.stringify(a)+"\nopt="+JSON.stringify(b));return"FTXT"===a.type?b.answer===b.response:b.correct}}]);
srsApp.controller("AssessmentCtrl",["$scope","$http","$routeParams","Shared","$filter","$location",function(a,c,e,g,d,b){g.requireLogin();a.A={questions:[]};a.pred="submittedOn";a.reverse=!1;C.log("Loaded AssessmentCtrl...");e=e.aid;void 0!==e?c.get("/assess/getAssessment.a?id="+e).success(function(b){"OK"===b.Status?a.A=b.Message:a.setStatus("Failed to load assessment.")}).error(function(b,c,d,e){a.setStatus(b.Message)}):g.aqList&&(a.A.questions=Array.from(g.aqList),delete g.aqList);a.save=function(){c.post("/assess/saveAssessment.a",
a.A).success(function(f){"OK"===f.Status?(a.A=f.Message,a.setStatus("Saved assessment!"),b.path("/Assessment/"+f.Message.assessId)):a.setStatus("Could not save assessment.")}).error(function(b,c,d,e){a.setStatus(b.Message)})};a.open=function(b,c){b.preventDefault();b.stopPropagation();"OD"===c?a.odOpen=!0:"CD"===c&&(a.cdOpen=!0)};a.toggleLookup=function(){a.showLookup=!a.showLookup;a.lookupQuery=void 0};a.setQuestion=function(b,c,d){a.A.questions.push(b);a.toggleLookup()};a.lookupQuestion=function(b){C.log("lookupQuestion...");
return c.get("/assess/lookupQuestions.a?q="+b,{params:{}}).then(function(b){"OK"!==b.data.Status&&a.setStatus("Lookup failed.");return b.data.Message})}}]);srsApp.controller("TrailDetailsCtrl",["$scope","$http","$routeParams","Shared","$location",function(a,c,e,g,d){g.requireLogin();a.Model={Trail:{assessments:[]},temp:{resource:{}},Contents:[]};void 0!==e.tid&&c.get("/trail/getTrailById.a?trailId="+e.tid).success(function(b){"OK"===b.Status?a.Model.Trail=b.Message:a.setStatus("Failed to get the Trail data.")});C.log("TrailDetailsCtrl: Loaded.");a.getContentsForUser=function(b){var f="/trail/getContentsForUser.a?userId="+g.User.userId;void 0!==b&&(f+=
"&q="+b);return c.get(f,{params:{}}).then(function(b){"OK"===b.data.Status?a.Model.Contents=b.data.Message:a.setStatus("Failed to get content for user.");return b.data.Message})};a.lookupAssessments=function(b){return c.get("/assess/lookupAssessments.a?q="+b,{params:{}}).then(function(b){"OK"!==b.data.Status&&a.setStatus("Failed to load assessments for user.");return b.data.Message})};a.toggleTALookup=function(){a.Model.temp.showTALookup=!a.Model.temp.showTALookup;a.Model.temp.selAssessment=void 0};
a.toggleRESLookup=function(){a.Model.temp.showRESLookup=!a.Model.temp.showRESLookup;a.Model.temp.resource={}};a.addResourceToTrail=function(){a.Model.temp.resource.itemId=a.Model.Trail.trailId+"_"+(a.Model.Trail.resources.length+1);a.Model.Trail.resources.push(a.Model.temp.resource);a.toggleRESLookup()};a.addAssessmentToTrail=function(b,c,d){b.trailId=a.Model.Trail.trailId;a.Model.Trail.assessments.push(b);a.toggleTALookup()};a.deleteRes=function(b){confirm("Confirm delete?")&&a.Model.Trail.resources.splice(b,
1)};a.saveTrail=function(){C.log("saveTrail()...");c.post("/trail/saveTrail.a",a.Model.Trail).success(function(b){"OK"===b.Status?(a.Model.Trail=b.Message,a.RootModel.modalStatus="Saved the trail!",a.setStatus("Saved the trail!")):a.setStatus("Failed to saved the trail!")})};a.deleteTrail=function(){C.log("deleteTrail()...");confirm("Are you sure you want to delete?")&&c.get("/trail/deleteTrail.a?trailId="+a.Model.Trail.trailId).success(function(b){C.log("Deleted trail: "+JSON.stringify(b));"OK"===
b.Status?(a.setStatus("Deleted the trail!"),d.path("/MyContent")):a.setStatus("Could not delete the trail!")})};a.sortableOptions={items:"tr",placeholder:'<tr><td colspan="4">&nbsp;</td></tr>'};a.sortableCallback=function(b,c,d,e){C.log("params="+JSON.stringify({startModel:b,destModel:c,start:d,end:e}));b=a.Model.Trail.videos.splice(d,1);a.Model.Trail.videos.splice(e,0,b[0]);angular.forEach(a.Model.Trail.videos,function(b,c){a.Model.Trail.videos[c].seqNo=c+1});a.$apply()}}]);
srsApp.controller("TrailViewCtrl",["$scope","$http","$routeParams","$filter","Shared","$window",function(a,c,e,g,d,b){a.Model={Trails:[],Trail:{},popoverMsg:void 0,SI:{},temp:{showComment:[],editComment:[]},Contents:[],Comment:{}};c.get("/trail/getTrailForView.a?trailId="+e.tid).success(function(b){"OK"===b.Status?(a.Model.Trail=b.Message,a.loadTrailItem(b.Message.videos[0]),a.Model.temp.subscribed=d.Subscriptions.some(function(a){return a.trailId===b.Message.trailId})):a.setStatus("Failed to get trail.")});
C.log("TrailViewCtrl: Loaded...");a.openCal=function(b,c){b.preventDefault();b.stopPropagation();"PA"===c?a.paOpen=!0:"PB"===c&&(a.pbOpen=!0)};a.searchComments=function(){a.Model.SI.trailId=a.Model.Trail.trailId;a.Model.SI.itemId=a.Model.TrailItem.itemId;C.log("SI: "+JSON.stringify(a.Model.SI));var b=a.Model.SI.postedAfter,d=a.Model.SI.postedBefore;void 0!==b&&(a.Model.SI.postedAfter=g("date")(b,"medium"));void 0!==d&&(a.Model.SI.postedBefore=g("date")(d,"medium"));return c.post("/trail/searchComments.a",
a.Model.SI).success(function(b){"OK"===b.Status?a.Model.Comments=b.Message:a.setStatus("Failed to search comments.")})};a.subscribeTrail=function(b){c.get("/trail/addSubs.a?tid="+b).success(function(b){"OK"===b.Status?(d.Subscriptions.splice(0,d.Subscriptions.length,b.Message),a.setStatus("Added subscription!"),a.Model.temp.subscribed=!0):a.setStatus("Failed to add subscription.")}).error(function(b,c,d,f){a.setStatus(b.Message)})};a.Model.getItemComments=function(b){return c.get("/trail/getComments.a?iid="+
b).success(function(b){"OK"===b.Status?a.Model.Comments=b.Message:a.setStatus("Failed to get comments.")})};a.loadTrailItem=function(c){if(void 0===c)a.RootModel.StatusMessage="Item not found!";else{C.log("Showing trailitem: "+JSON.stringify(c));$("#videoLoadMsg").show();a.Model.videoLoaded=!1;a.Model.TrailItem=c;var d=.7*b.innerWidth,e=.75*b.innerHeight;C.log("w x h = "+d+" x "+e);d="<iframe width='"+d+"' height='"+e+"' src='"+a.RootModel.getVideoUrl(c.url)+"'frameborder='0' allowfullscreen onload='$(\"#videoLoadMsg\").hide(\"slow\")'></iframe>";
$("#tivideo").html(d);a.Model.getItemComments(c.itemId);a.Model.videoLoaded=!0}};a.isItemActive=function(b){return a.Model.TrailItem===b?"active":!1};a.itemHasResources=function(){var b=a.Model.Trail.resources;return void 0!==b&&0<b.length};a.editComment=function(b){d.User.loggedIn&&(a.Model.temp.Comment=b)};a.replyToComment=function(b){d.User.loggedIn&&(a.Model.temp.Comment={},a.Model.temp.Comment.inReplyTo=b.commentId,a.Model.temp.Comment.level=b.level+1)};a.newComment=function(){d.User.loggedIn&&
(a.Model.temp.Comment={level:0,trailItemId:a.Model.TrailItem.itemId})};a.removeComment=function(b){C.log("Removing comment id:"+JSON.stringify(b));return c.get("/trail/deleteComment.a?cid="+b.commentId).success(function(c){"OK"===c.Status?0<c.Message?a.Model.getItemComments(b.trailItemId):a.setStatus("Could not remove comment!"):a.setStatus("Failed to remove comment!")})};a.commentLevel=function(a){var b=[];b.push("col-md-offset-"+a);b.push("col-md-8");return b};a.addDiscussionPost=function(){C.log("addDiscussionPost():: ")};
a.Model.temp.cid=0;a.postReply=function(){if(d.User.loggedIn){var b=a.Model.TrailItem.itemId;a.Model.temp.Comment.trailItemId=b;1>a.Model.temp.Comment.commentId&&a.Model.Comments.unshift(a.Model.temp.Comment);c.post("/trail/saveComment.a",a.Model.temp.Comment).success(function(c){"OK"===c.Status?(a.Model.getItemComments(b),a.setStatus("Saved comment!")):a.setStatus("Failed to save the comment!");$("#postModal").modal("toggle")})}}}]);
